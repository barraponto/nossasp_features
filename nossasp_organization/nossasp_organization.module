<?php

include_once('nossasp_organization.features.inc');

function nossasp_organization_views_pre_view(&$view) {
  if ($view->name == 'nossasp_organization_update_orgs') {
    $empty_text = 'Você ainda não cadastrou nenhuma organização.'. ' ' . l('Que tal começar agora?','node/add/nossasp-organization');
    $view->display_handler->set_option('empty', $empty_text);
  }
  elseif ($view->name == 'nossasp_organizations_map') { 
    if (drupal_is_front_page() &! (isset($_GET['circle']) || isset($_GET['title']))) {
      $view->display_handler->set_option('style_options', array('preset' => 'nossasp_all'));
    }
  }
  elseif ($view->name == 'nossasp_organizations_search' && $view->current_display == 'openlayers_1' &! empty($_GET['page'])) { 
    if (is_numeric($_GET['page'])) {
      $view->display_handler->set_option('offset', $_GET['page'] * 9);
    }
  }
}

function nossasp_organization_views_pre_render(&$view) {
  if ($view->name == 'nossasp_organizations_search_box') {
    $header_text = '<p class="counter"><span class="number">' . $view->total_rows  . '</span> resultados</p>';
    $header_text .= '<p class="download">' . l('Baixe o banco de dados do mapa', 'organizations/data') . '</p>';
    $view->display_handler->set_option('header', $header_text);
  }
  elseif ($view->name == 'nossasp_organizations_search' && $view->current_display == 'openlayers_1') {
  }
}

function nossasp_organization_perm() {
  return array('create municipal councils');
}

function nossasp_organization_form_alter(&$form, &$form_state, $form_id) {
  if ($form_id == 'views_exposed_form' && $form['#id'] == 'views-exposed-form-nossasp-organizations-map-page-2') {
    $form['circle']['location']['#autocomplete_path'] = 'openlayers/geocoder/response';
    drupal_add_css(drupal_get_path('module','nossasp_organization') . '/nossasp-organization-search.css');
    $form['title']['#size'] = $form['circle']['location']['#size'] = 72;
    $form['tid']['#type'] = 'checkboxes';
    $form['#after_build'][] = 'nossasp_organization_exposed_search';
    $form['tid_1']['#attributes'] = array('class' => 'jquery_dropdown');
  }
  elseif ($form_id == 'nossasp_organization_node_form') {
    global $user;
    $form['field_tipo']['#title'] = $form['field_atuacao']['#title'] = FALSE;
    if (user_access('create municipal councils')) {
      drupal_add_js(drupal_get_path('module', 'nossasp_organization') . '/nossasp-organization-node-form.js');
    }
    if ($user->uid == 0) {
      $form['#after_build'][] = 'nossasp_organization_add_org_on_signup';
      unset($form['body_field']['format']);
      unset($form['body_field']['teaser_js']);
      unset($form['body_field']['teaser_include']);
      unset($form['body_field']['#after_build']);
      $form['body_field']['body']['#rows'] = 5;
    }
  }
  elseif (in_array($form_id, array('contact_mail_page', 'user_login', 'user_pass'))) { 
    $form['title'] = array(
      '#value' => '<h1 class="form-title">' . drupal_get_title() . '</h1>',
      '#weight' => -42,
    );
  }
}

function nossasp_organization_exposed_search($form, &$form_state) {

  $form['circle']['value']['#value'] = 3;
  $form['circle']['value']['#type'] = $form['circle_op']['#type'] = 'hidden';
  unset($form['circle']['location']['#field_prefix']);
  $form['circle']['min']['#access'] = $form['circle']['max']['#access'] = FALSE;
  $form['submit']['#weight'] = 0;

  // Workaroud for the ugly <All> option
  $form['tid_1']['#options']['All'] = 'Tipo de Organização';

  // turn apply into OK
  $form['submit']['#value'] = 'Buscar';

  return $form;
}

function nossasp_organization_add_org_on_signup($form, &$form_state) { 
  $form['group_tipo']['field_tipo']['value']['#type'] = 'select';
  unset($form['field_address']['map']);
  unset($form['field_address']['openlayers_wkt']);
  return $form;
}
